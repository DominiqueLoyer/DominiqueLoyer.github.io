<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Portfolio de Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #drop-zone {
            border: 4px dashed #cbd5e1;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #drop-zone.drag-over {
            border-color: #2563eb;
            background-color: #eff6ff;
        }
        #output-html {
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Générateur de Portfolio</h1>
            <p class="text-lg text-gray-600 mt-2">1. Glissez vos fichiers → 2. Générez → 3. Copiez le code HTML</p>
        </header>

        <!-- Étape 1: Zone de dépôt -->
        <div id="drop-zone" class="w-full rounded-lg p-8 text-center bg-white shadow-md mb-8">
            <p id="drop-message" class="text-xl text-gray-500">Glissez tous vos fichiers de code ici (.py, .ipynb, etc.)</p>
            <div id="preview-container" class="mt-4 text-left"></div>
        </div>

        <!-- Étape 2: Bouton de génération -->
        <div class="text-center mb-8">
            <button id="generate-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition disabled:bg-gray-400" disabled>
                Générer le HTML du Portfolio
            </button>
        </div>

        <!-- Étape 3: Zone de résultat -->
        <div id="result-container" class="hidden">
            <h2 class="text-2xl font-semibold mb-4">Code HTML généré :</h2>
            <div class="relative">
                <textarea id="output-html" class="w-full h-96 p-4 border rounded-lg bg-gray-900 text-white" readonly></textarea>
                <button id="copy-btn" class="absolute top-2 right-2 bg-gray-700 text-white py-1 px-3 rounded hover:bg-gray-600">Copier</button>
            </div>
            <p class="mt-4 text-green-700 font-semibold">C'est prêt ! Copiez ce code et collez-le dans le fichier `Codes.html` de votre dépôt GitHub.</p>
        </div>

    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const dropMessage = document.getElementById('drop-message');
        const previewContainer = document.getElementById('preview-container');
        const generateBtn = document.getElementById('generate-btn');
        const resultContainer = document.getElementById('result-container');
        const outputHtml = document.getElementById('output-html');
        const copyBtn = document.getElementById('copy-btn');

        let processedFiles = [];

        // --- Gestion du Glisser-Déposer ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
        });

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length === 0) return;

            dropMessage.textContent = "Traitement en cours...";
            previewContainer.innerHTML = ''; // Réinitialiser l'aperçu
            processedFiles = []; // Réinitialiser les fichiers traités

            let filesToProcess = files.length;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    processFile(file, event.target.result);
                    filesToProcess--;
                    if (filesToProcess === 0) {
                        dropMessage.textContent = `${processedFiles.length} fichier(s) prêt(s) à être généré(s).`;
                        generateBtn.disabled = false;
                    }
                };
                reader.onerror = function() {
                    console.error("Erreur de lecture du fichier:", file.name);
                    filesToProcess--;
                    if (filesToProcess === 0) {
                        generateBtn.disabled = processedFiles.length === 0;
                    }
                };
                reader.readAsText(file);
            });
        }

        function processFile(file, content) {
            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();
            let codeToDisplay = '';
            let language = 'plaintext';

            // Détection du langage pour la coloration syntaxique
            const langMap = { py: 'python', js: 'javascript', html: 'xml', css: 'css', ipynb: 'python' };
            language = langMap[fileExtension] || 'plaintext';

            // Traitement spécifique pour les notebooks Jupyter (.ipynb)
            if (fileExtension === 'ipynb') {
                try {
                    const notebook = JSON.parse(content);
                    codeToDisplay = notebook.cells
                        .filter(cell => cell.cell_type === 'code')
                        .map(cell => cell.source.join(''))
                        .join('\n\n# --- Nouvelle Cellule ---\n\n');
                } catch (error) {
                    console.error(`Erreur de parsing JSON pour ${fileName}:`, error);
                    codeToDisplay = `ERREUR: Impossible de lire ce fichier .ipynb. Le fichier est peut-être corrompu.`;
                }
            } else {
                codeToDisplay = content;
            }
            
            // Échapper les caractères HTML dans le code pour un affichage correct
            const escapedCode = codeToDisplay
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            processedFiles.push({ name: fileName, lang: language, code: escapedCode });
            
            // Afficher un aperçu simple
            const p = document.createElement('p');
            p.className = 'text-sm text-gray-600';
            p.textContent = `✓ ${fileName}`;
            previewContainer.appendChild(p);
        }

        // --- Génération du HTML ---
        generateBtn.addEventListener('click', () => {
            const finalHtml = generatePortfolioHtml(processedFiles);
            outputHtml.value = finalHtml;
            resultContainer.classList.remove('hidden');
            window.scrollTo({ top: resultContainer.offsetTop, behavior: 'smooth' });
        });

        function generatePortfolioHtml(files) {
            // Utilisation de la concaténation de chaînes pour une robustesse maximale
            const articles = files.map(file => {
                return '\n            <!-- Bloc pour ' + file.name + ' -->\n' +
                       '            <article class="bg-white rounded-lg shadow-lg overflow-hidden">\n' +
                       '                <header class="p-5 bg-gray-800 text-white">\n' +
                       '                    <h2 class="text-2xl font-semibold">' + file.name + '</h2>\n' +
                       '                    <p class="text-gray-300 mt-1">Description du script.</p>\n' +
                       '                </header>\n' +
                       '                <div class="p-5">\n' +
                       '                    <pre><code class="language-' + file.lang + '">' + file.code + '</code></pre>\n' +
                       '                </div>\n' +
                       '                <footer class="bg-gray-50 border-t border-gray-200 p-5">\n' +
                       '                    <h3 class="font-semibold text-gray-700">Pour citer ce code :</h3>\n' +
                       '                    <div class="mt-2 text-sm text-gray-600 bg-gray-100 p-3 rounded-md">\n' +
                       '                        <p>Loyer, Dominique. (2024). <em>' + file.name + '</em> [Code source]. Repris de https://dominiqueloyer.github.io/Codes.html</p>\n' +
                       '                    </div>\n' +
                       '                </footer>\n' +
                       '            </article>';
            }).join('\n\n\n');

            // Concaténation pour le document final pour éviter toute erreur
            let finalHtml = '';
            finalHtml += '<!DOCTYPE html>\n';
            finalHtml += '<html lang="fr">\n';
            finalHtml += '<head>\n';
            finalHtml += '    <meta charset="UTF-8">\n';
            finalHtml += '    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n';
            finalHtml += '    <title>Portfolio de Codes | Dominique Loyer</title>\n';
            finalHtml += '    <script src="https://cdn.tailwindcss.com"><\/script>\n';
            finalHtml += '    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">\n';
            finalHtml += '    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"><\/script>\n';
            finalHtml += '    <style>\n';
            finalHtml += '        pre code.hljs { white-space: pre-wrap; word-break: break-all; }\n';
            finalHtml += '    </style>\n';
            finalHtml += '</head>\n';
            finalHtml += '<body class="bg-gray-100 font-sans text-gray-800">\n';
            finalHtml += '    <div class="container mx-auto p-4 md:p-8">\n';
            finalHtml += '        <header class="text-center mb-12">\n';
            finalHtml += '            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Portfolio de Codes</h1>\n';
            finalHtml += '            <p class="text-lg text-gray-600 mt-2">Une collection de mes projets partagés publiquement.</p>\n';
            finalHtml += '        </header>\n';
            finalHtml += '        <main class="space-y-12">\n';
            finalHtml += articles;
            finalHtml += '\n        </main>\n';
            finalHtml += '    </div>\n';
            finalHtml += '    <script>\n';
            finalHtml += '        hljs.highlightAll();\n';
            finalHtml += '    <\/script>\n';
            finalHtml += '</body>\n';
            finalHtml += '</html>';

            return finalHtml;
        }
        
        // --- Bouton Copier ---
        copyBtn.addEventListener('click', () => {
            outputHtml.select();
            document.execCommand('copy');
            copyBtn.textContent = 'Copié !';
            setTimeout(() => { copyBtn.textContent = 'Copier'; }, 2000);
        });

    </script>
</body>
</html>
